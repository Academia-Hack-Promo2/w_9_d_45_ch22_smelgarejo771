/*!CK:2092705940!*//*1429309274,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["30exZ"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};},null);
__d("MercuryActionType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={LOG_MESSAGE:"ma-type:log-message",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",MARK_THREAD_SEEN:"ma-type:mark_thread_seen",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings",SEND_MESSAGE:"ma-type:send-message",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",MARK_MESSAGES_SPAM:"ma-type:mark-messages-spam",DELETE_THREAD:"ma-type:delete-thread",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",CHANGE_FOLDER:"ma-type:change-folder",ADD_PARTICIPANTS:"ma-type:add-participants",CANCEL_ATTACHMENT_PLACEHOLDER:"ma-type:cancel-attachment-placeholder",CONFIRM_ATTACHMENT_PLACEHOLDER:"ma-type:confirm-attachment-placeholder",ADD_SHARE_DATA_TO_EXISTING_MESSAGE:"ma-type:add-share-data-to-existing-message",UNPIN_THREAD:"ma-type:unpin-thread"};},null);
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",MERCURYSYNC:"mercury_sync",WEBMESSENGER:"web_messenger",MESSENGER:"messenger"};},null);
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",ORION:"attach:orion",SHOERACK_INVITATION:"attach:shoerackinvite",UNKNOWN:"attach:unknown"};},null);
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",UNKNOWN:"unknown",VIDEO:"video",ANIMATED_IMAGE:"animated_image"};},null);
__d("MercuryAudioType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={AudioClip:"fb_voice_message",VoiceMessageWithTranscript:"fb_voice_message_with_transcript"};},null);
__d("MercuryErrorType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};},null);
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};},null);
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper",ORION:"log:orion",SWITCH_TO_WORK:"log:switch",PAGE_REPLY:"log:page-reply"};},null);
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_MARK_THREAD_SEEN:"client_mark_thread_seen",CLIENT_ADD_PARTICIPANTS:"client_add_participants",CLIENT_FETCH_PARTICIPANTS:"client_fetch_participants",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_MARK_MESSAGES_SPAM:"client_mark_messages_spam",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",CLIENT_UNPIN_THREAD:"client_unpin_thread",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_PARTICIPANTS:"server_fetch_participants",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_STANDALONE_NOTIFICATIONS:"server_standalone_notifications",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search",SERVER_ADD_SHARE_DATA_TO_EXISTING_MESSAGE:"server_add_share_data_to_existing_message"};},null);
__d("MercurySendMessageFields",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={AUTO_RETRY_CNT:"auto_retry_cnt",MANUAL_RETRY_CNT:"manual_retry_cnt"};},null);
__d("MercurySourceType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT_FORWARD_DIALOG:"source:chat:forward",CHAT:"source:chat",EMAIL:"source:email",EVENT_MESSAGE_BLAST:"source:event_message_blast",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",MESSENGER_WEB:"source:messenger:web",SAM_UFI:"source:sam:ufi",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_FREE:"source:titan:m_free_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",PAGE_PLATFORM_API:"source:page_platform_api",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile",MESSENGER_COMMERCE:"source:messenger:commerce"};},null);
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};},null);
__d("MessagingTag",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={GROUPS:"groups",UNREAD:"unread",FLAGGED:"flagged",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",UNAVAILABLE_ATTACHMENT:"unavailable_attachment",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};},null);
__d("StoryAttachmentStyle",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={FALLBACK:"fallback",SHARE:"share",OG_COMPOSER_SIMPLE:"og_composer_simple",SPORTS_MATCHUP:"sports_matchup",SHARE_LARGE_IMAGE:"share_large_image",PHOTO:"photo",COVER_PHOTO:"cover_photo",ALBUM:"album",NEW_ALBUM:"new_album",COUPON:"coupon",QUESTION:"question",ANSWER:"answer",OPTION:"option",GALLERY:"gallery",STREAM_PUBLISH:"stream_publish",MUSIC_AGGREGATION:"music_aggregation",ITEM_LIST:"list",HIGH_SCORE:"high_score",SCORE_LEADERBOARD:"score_leaderboard",FRIEND_LIST:"friend_list",CHECKIN:"checkin",POPULAR_OBJECTS:"popular_objects",AVATAR_LIST:"avatar_list",AVATAR:"avatar",AVATAR_WITH_VIDEO:"avatar_with_video",EVENT:"event",EXPERIENCE:"experience",LIFE_EVENT:"life_event",TRAVEL_SLIDESHOW_LIFE_EVENT:"travel_slideshow_life_event",GIFT:"gift",IMAGE_SHARE:"image_share",ANIMATED_IMAGE_SHARE:"animated_image_share",ANIMATED_IMAGE_AUTOPLAY:"animated_image_autoplay",NOTE:"note",TOPIC:"topic",FILE_UPLOAD:"file_upload",NOTIFICATION_TARGET:"notification_target",UNAVAILABLE:"unavailable",PAGE_RECOMMENDATION:"page_recommendation",PAGE_VIDEO_PLAYLIST:"page_video_playlist",VIDEO:"video",VIDEO_INLINE:"video_inline",VIDEO_AUTOPLAY:"video_autoplay",VIDEO_SHARE:"video_share",VIDEO_SHARE_HIGHLIGHTED:"video_share_highlighted",VIDEO_SHARE_YOUTUBE:"video_share_youtube",MAP:"map",OG_MAP:"og_map",PRODUCT:"product",EXTERNAL_PRODUCT:"external_product",FITNESS_COURSE:"fitness_course",APPLICATION:"application",STICKER:"sticker",EXTERNAL_OG_PRODUCT:"external_og_product",TRAVEL_LOG:"travel_log",MULTI_SHARE:"multi_share",MULTI_SHARE_NO_END_CARD:"multi_share_no_end_card",YEAR_IN_REVIEW:"year_in_review",AVATAR_LARGE_COVER:"avatar_large_cover",BROADCAST_REQUEST:"broadcast_request",COMMERCE_PRODUCT_ITEM:"commerce_product_item",COMMERCE_STORE:"commerce_store",THIRD_PARTY_PHOTO:"third_party_photo",PROMPT:"prompt",BIRTHDAY:"birthday",DONATIONS_CAMPAIGN:"donations_campaign",DONATE_PROMPT:"donate_prompt",DISCUSSION_CONVERSATION:"discussion_conversation",DISCUSSION_COMMENT:"discussion_comment",GROUP_SELL_PRODUCT_ITEM:"group_sell_product_item",GROUP_SELL_PRODUCT_ITEM_MARK_AS_SOLD:"group_sell_mark_as_sold",GAMETIME:"gametime",GROUP_REPORTED_POST_QUEUE:"group_reported_post_queue",GROUP_PENDING_POST_QUEUE:"group_pending_post_queue",GROUP_JOIN_REQUEST_QUEUE:"group_join_request_queue",GREETING_CARD:"greeting_card",LEAD_GEN:"lead_gen",ATTACHED_STORY:"attached_story",SOUVENIR:"souvenir",SLIDESHOW:"slideshow",ORION:"orion",ORION_REQUEST:"orion_request",RETAIL_ITEM:"retail_item",RETAIL_RECEIPT:"retail_receipt",INSTANT_ARTICLE:"instant_article",RETAIL_CANCELLATION:"retail_cancellation",JOIN_TOPIC_CONVERSATION:"join_topic_conversation",MOMENTS_APP_INVITATION:"moments_app_invitation",RETAIL_SHIPMENT:"retail_shipment",RETAIL_SHIPMENT_TRACKING_EVENT:"retail_shipment_tracking_event",SURVEY:"survey",MESSAGE_LOCATION:"message_location",JOB_OFFER:"job_offer",GROUP_ADD_MEMBERS:"group_add_memebers",RTC_CALL_LOG:"rtc_call_log",EVENT_CALENDAR:"event_calendar",FACEPILE:"facepile",VIDEO_CINEMAGRAPH:"video_cinemagraph"};},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("MercurySendAttemptLogger",["Banzai","BanzaiLogger","MercuryAttachmentType","MercurySendMessageFields"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();var k=h.create({retry:true}),l=g.isEnabled('mercury_send_attempt_logging'),m=function(o){if(!o.has_attachment)return null;if(o.sticker_id)return i.STICKER;if((o.image_ids&&o.image_ids.length)||(o.photo_fbids&&o.photo_fbids.length))return i.PHOTO;if(o.raw_attachments&&o.raw_attachments.length)return i.FILE;if(o.content_attachment)return i.SHARE;return i.UNKNOWN;},n={log:function(o){if(!l)return;var p={message_id:o.message_id,timestamp_client:Date.now(),attempt_num:o[j.MANUAL_RETRY_CNT],first_attachment_type:m(o),source:o.source,auto_retry_cnt:o[j.AUTO_RETRY_CNT]};k.log('MercurySendAttemptLoggerConfig',p);}};e.exports=n;},null);
__d("MercurySendErrorLogger",["Banzai","BanzaiLogger"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i=h.create({retry:true}),j=g.isEnabled('mercury_send_error_logging'),k={log:function(l){if(!j)return;var m={message_id:l.message_id,timestamp_client:Date.now(),error_type:l.error_data.type,error_code:l.error_data.code,error_description:l.error_data.description,is_transient:l.error_data.is_transient};i.log('MercurySendErrorLoggerConfig',m);}};e.exports=k;},null);
__d("MercuryServerSendMessageQueueSimulatedError",["AsyncRequest","AsyncResponse","copyProperties"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j=9999,k={create:function(l){var m=new g(this.endpoint_uri).setData({message_batch:[l],client:this.client}),n=new h(m,{});i(n,{error:j,silentError:false,transientError:true,request:m});return n;}};e.exports=k;},null);
__d("MercuryServerSendMessageQueue",["BanzaiODS","LogHistory","MercuryLoggingHelper","MercuryServerDispatcher","MercuryServerSendMessageQueueSimulatedError"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l='/ajax/mercury/send_messages.php',m=h.getInstance('mercury_server_send_message_queue');function n(o,p,q,r){"use strict";this.sender_id=o;this.queue_id=p;this.$MercuryServerSendMessageQueue0=q.success_handler;this.$MercuryServerSendMessageQueue1=q.error_handler;this.$MercuryServerSendMessageQueue2=q.transport_error_handler;this.$MercuryServerSendMessageQueue3=q.timeout_handler;this.client=r;var s={};s[l]={request_user_id:this.sender_id,endpoint_id:this.queue_id,mode:j.IMMEDIATE,handler:this.handleSuccess.bind(this),error_handler:this.handleError.bind(this),transport_error_handler:this.handleTransportError.bind(this),timeout:q.timeout,timeout_handler:this.handleTimeout.bind(this),connection_retries:q.connection_retries,send_attempt_logging_handler:q.send_attempt_logging_handler,auto_retries:q.auto_retries};j.registerEndpoints(s);this.pending_message=null;this.queue=[];}n.prototype.enqueue=function(o){"use strict";this.queue.push(o);this.$MercuryServerSendMessageQueue4();};n.prototype.$MercuryServerSendMessageQueue4=function(){"use strict";if(this.pending_message||!this.queue.length){if(this.pending_message)this.$MercuryServerSendMessageQueue5();return;}this.pending_message=this.queue.shift();j.trySend(l,{message_batch:[this.pending_message],client:this.client},null,this.sender_id,this.queue_id);};n.prototype.$MercuryServerSendMessageQueue6=function(){"use strict";while(this.queue.length)this.$MercuryServerSendMessageQueue7(this.queue.shift());};n.prototype.$MercuryServerSendMessageQueue7=function(o){"use strict";this.$MercuryServerSendMessageQueue1(k.create(o));m.error('mark_as_failed',{fbid:this.sender_id,queue_id:this.queue_id,message:i.obfuscateMessage(o)});};n.prototype.handleSuccess=function(o,p){"use strict";this.$MercuryServerSendMessageQueue0(o,p);this.pending_message=null;this.$MercuryServerSendMessageQueue4();};n.prototype.handleError=function(o){"use strict";this.$MercuryServerSendMessageQueue1(o);this.$MercuryServerSendMessageQueue6();this.pending_message=null;};n.prototype.handleTransportError=function(o){"use strict";this.$MercuryServerSendMessageQueue2(o);this.$MercuryServerSendMessageQueue6();this.pending_message=null;};n.prototype.handleTimeout=function(o){"use strict";this.$MercuryServerSendMessageQueue3(o);this.$MercuryServerSendMessageQueue6();this.pending_message=null;};n.prototype.$MercuryServerSendMessageQueue5=function(){"use strict";m.debug('maybe_send_next_pending_message',{fbid:this.sender_id,queue_id:this.queue_id,pending_message:i.obfuscateMessage(this.pending_message),queue:this.queue.map(function(p){return i.obfuscateMessage(p);})});var o='send_queue.delayed.queue_length.'+this.queue.length.toString();g.bumpEntityKey('chat.web',o);};e.exports=n;},null);
__d("MercuryServerSendMessageQueueRouter",["BanzaiODS","LogHistory","Map","MercuryServerSendMessageQueue","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l=h.getInstance('mercury_server_send_message_queue_router'),m='chat.web.send_queue_router';g.setEntitySample(m,.1);function n(o){"use strict";this.fbid=o;this.queues=new i();}n.prototype.enqueue=function(o,p,q,r){"use strict";if(!this.queues.has(o)){this.queues.set(o,new j(this.fbid,o,p,q));l.debug('added queue',{fbid:this.fbid,queue_id:o});g.bumpEntityKey(m,'new_queue');}this.queues.get(o).enqueue(r);};Object.assign(n,k);e.exports=n;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==(void 0)){var da=ba[ca];if(da!==(void 0))p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==(void 0))p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);
__d("MercuryServerSendMessageQueueOptions",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h,i,j,k,l,m,n,o){"use strict";this.success_handler=h;this.error_handler=i;this.transport_error_handler=j;this.timeout_handler=k;this.send_attempt_logging_handler=l;this.timeout=m;this.connection_retries=n;this.auto_retries=o;}e.exports=g;},null);
__d("MercuryThreadInformer",["ArbiterMixin","LogHistory","MercuryAssert","MercuryLoggingHelper","MercurySingletonMixin","copyProperties","mapObject","mixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.__markCompiled&&b.__markCompiled();'use strict';var o=h.getInstance('mercury_informer'),p=n(g);for(var q in p)if(p.hasOwnProperty(q))s[q]=p[q];var r=p===null?null:p.prototype;s.prototype=Object.create(r);s.prototype.constructor=s;s.__superConstructor__=p;function s(u){this.$MercuryThreadInformer0=u;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};this.$MercuryThreadInformera=0;}s.prototype.updatedThread=function(u){this.$MercuryThreadInformer2[u]=true;this.$MercuryThreadInformerb();};s.prototype.deletedThread=function(u){this.$MercuryThreadInformer1[u]=true;this.$MercuryThreadInformerb();};s.prototype.updatedThreadlist=function(){this.$MercuryThreadInformer4=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnseenState=function(){this.$MercuryThreadInformer5=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnreadState=function(){this.$MercuryThreadInformer6=true;this.$MercuryThreadInformerb();};s.prototype.changedThreadReadState=function(u,v,w){if(!this.$MercuryThreadInformer3[u]||this.$MercuryThreadInformer3[u].timestamp<w)this.$MercuryThreadInformer3[u]={mark_as_read:v,timestamp:w};this.$MercuryThreadInformerb();};s.prototype.receivedMessage=function(u){i.isThreadID(u.thread_id);var v=u.thread_id;if(!this.$MercuryThreadInformer7[v])this.$MercuryThreadInformer7[v]=[];this.$MercuryThreadInformer7[v].push(u);this.updatedThread(v);};s.prototype.reorderedMessages=function(u,v){this.$MercuryThreadInformer8[u]={source:v};this.$MercuryThreadInformerb();};s.prototype.updatedMessage=function(u,v,w){if(!this.$MercuryThreadInformer9[u])this.$MercuryThreadInformer9[u]={};this.$MercuryThreadInformer9[u][v]={source:w};this.updatedThread(u);};s.prototype.synchronizeInforms=function(u){this.$MercuryThreadInformera++;try{u();}catch(v){throw v;}finally{this.$MercuryThreadInformera--;this.$MercuryThreadInformerb();}};s.prototype.listen=function(u,v){return this.subscribe('threads-updated',function(w,x){if(x[u])v(u);});};s.prototype.$MercuryThreadInformerb=function(){if(!this.$MercuryThreadInformera){var u=this.$MercuryThreadInformer1,v=this.$MercuryThreadInformer2,w=this.$MercuryThreadInformer3,x=this.$MercuryThreadInformer4,y=this.$MercuryThreadInformer5,z=this.$MercuryThreadInformer6,aa=this.$MercuryThreadInformer7,ba=this.$MercuryThreadInformer8,ca=this.$MercuryThreadInformer9;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};var da=Object.keys(v);if(da.length||x)this.$MercuryThreadInformerc('threadlist-updated',da);if(da.length)this.$MercuryThreadInformerc('threads-updated',v);for(var ea in w){this.$MercuryThreadInformerc('thread-read-changed',w);break;}for(ea in u){this.$MercuryThreadInformerc('threads-deleted',u);break;}if(y)this.$MercuryThreadInformerc('unseen-updated',null);if(z)this.$MercuryThreadInformerc('unread-updated',null);for(ea in aa){this.$MercuryThreadInformerc('messages-received',aa);break;}for(ea in ba){this.$MercuryThreadInformerc('messages-reordered',ba);break;}for(ea in ca){this.$MercuryThreadInformerc('messages-updated',ca);break;}}};s.prototype.$MercuryThreadInformerc=function(u,v){t(u,v);this.inform(u,v);};function t(u,v){var w=v;if(u=='messages-received')w=m(w,function(x){return x.map(function(y){return j.obfuscateMessage(y);});});o.debug(u,w);}l(s,k);e.exports=s;},null);
__d("MercuryServerRequests",["Arbiter","ArbiterMixin","AsyncResponse","BanzaiLogger","ChannelConstants","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionType","MercuryAPIArgsSource","MercuryAssert","MercuryErrorType","MercuryGlobalActionType","MercuryIDs","MercuryLoggingHelper","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendAttemptLogger","MercurySendErrorLogger","MercuryServerRequestsConfig","MercuryServerSendMessageQueueRouter","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryServerSendMessageQueueOptions","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa){b.__markCompiled&&b.__markCompiled();'use strict';var qa=n.getInstance('mercury_server'),ra=q.MERCURY;function sa(tb,ub){if(ub)tb._lastActionTimestamp=Math.max(tb._lastActionTimestamp,ub);}function ta(tb,ub){var vb=ub.thread_fbid;if(ub.canonical_fbid)vb=ub.canonical_fbid;var wb=tb._FBIDToClientIDs.getResource(vb);if(!wb){if(ub.canonical_fbid){wb='user:'+ub.canonical_fbid;}else if(ub.root_message_threading_id)wb='root:'+ub.root_message_threading_id;wb=wb||'thread:'+vb;if(vb)vb=vb.toString();va(tb,vb,wb);if(ub.thread_id)ua(tb,ub.thread_id,wb);}ub.thread_id=wb;}function ua(tb,ub,vb){tb._serverToClientIDs.setResource(ub,vb);tb._clientToServerIDs.setResource(vb,ub);tb._newlyAddedClientIDs[ub]=vb;}function va(tb,ub,vb){tb._clientIDToFBIDs.setResource(vb,ub);tb._FBIDToClientIDs.setResource(ub,vb);tb._newlyAddedClientIDs[ub]=vb;}function wa(tb,ub,vb){var wb=tb._clientIDToFBIDs.executeOrEnqueue(ub,vb),xb=tb._clientIDToFBIDs.getUnavailableResources(wb),yb=u.tokenize(ub);if(xb.length&&yb.type!='root')tb.fetchThreadData(xb);}function xa(tb,ub){return tb._clientIDToFBIDs.getResource(ub);}function ya(tb,ub){return !!tb._FBIDToClientIDs.getResource(ub);}function za(tb,ub){var vb=tb._serverToClientIDs.getResource(ub);if(typeof vb=='undefined')qa.warn('no_client_thread_id',{server_id:ub});return vb;}function ab(tb,ub){var vb=tb._FBIDToClientIDs.getResource(ub);if(typeof vb=='undefined')qa.warn('no_client_thread_id',{thread_fbid:ub});return vb;}function bb(tb,ub,vb){tb._FBIDToClientIDs.executeOrEnqueue(ub,vb);tb.ensureThreadIsFetched(ub);}function cb(tb){return tb.thread_fbid||tb.thread_id||tb.client_thread_id;}function db(tb,ub,vb){if(ub.action_type!=p.SEND_MESSAGE)return;var wb=ub.thread_fbid;if(ub.other_user_fbid)wb=ub.other_user_fbid;var xb=ub.client_thread_id;if(!xb)xb=ab(tb,wb);var yb=null;if(xb)yb=u.tokenize(xb).type;fb(tb,ub,vb==='success');if(ub.status===o.ERROR){aa.log(ub);}else ia.addEntry('send_'+yb,vb,wb+','+ub.message_id);}function eb(tb){return tb.getError()?'_'+tb.getError():'';}function fb(tb,ub,vb){if(Math.floor(Math.random()*20)===0)if(ub.client_message_id in tb._sentMessagesTimestamp){var wb=tb._sentMessagesTimestamp[ub.client_message_id],xb=Date.now()-wb,yb=ub.client_thread_id;if(!yb)yb=ab(tb,ub.thread_fbid);j.log('WebMessagingLatencyLoggerConfig',{has_attachment:ub.attachments&&ub.attachments.length>0,latency:xb,is_canonical:!u.isMultichat(yb),send_successful:vb,source:'client'});}}function gb(tb,ub){var vb=null;switch(ub.status){case o.SUCCESS:vb='success';break;case o.FAILED_UNKNOWN_REASON:vb='confirmed_error';break;case o.UNABLE_TO_CONFIRM:vb='confirm_error';break;default:return;}db(tb,ub,vb);}function hb(tb,ub){(ub.threads||[]).forEach(function(ec){ta(tb,ec);delete tb._fetchingThreads[ec.thread_id];var fc=xa(tb,ec.thread_id);delete tb._fetchingThreads[fc];sa(tb,ec.timestamp);});(ub.ordered_threadlists||[]).forEach(function(ec){var fc=ec.thread_fbids||[];fc=fc.concat(ec.other_user_fbids||[]);ec.thread_ids=fc.map(ab.bind(null,tb));});if(ub.pinned_threads&&ub.pinned_threads.thread_fbids)ub.pinned_threads.thread_fbids=ub.pinned_threads.thread_fbids.map(ab.bind(null,tb));ub.actions=ub.actions||[];ub.actions.forEach(function(ec){gb(tb,ec);var fc=ec.thread_fbid;if(ec.other_user_fbid)fc=ec.other_user_fbid;if(ec.status&&ec.status!=o.SUCCESS&&!fc){ec.thread_id=ec.client_thread_id;return;}if(ec.action_type==p.SEND_MESSAGE&&ec.client_thread_id&&fc)va(tb,fc.toString(),ec.client_thread_id);var gc=ec.thread_id;if(fc){ec.thread_id=ya(tb,fc)?ab(tb,fc):null;}else if(ec.client_thread_id)ec.thread_id=ec.client_thread_id;if(!ec.thread_id)ec.server_thread_id=gc;if(!ub.payload_source||!ub.payload_source.startsWith('server'))sa(tb,ec.timestamp);});if(ub.end_of_history){var vb=[];for(var wb=0;wb<ub.end_of_history.length;wb++){var xb=ub.end_of_history[wb];if(xb.type=='user'){vb.push('user:'+xb.fbid);}else if(xb.type=='thread'&&ya(tb,xb.fbid))vb.push(ab(tb,xb.fbid));}ub.end_of_history=vb;}if(ub.roger){var yb={};for(var zb in ub.roger){var ac=tb._FBIDToClientIDs.getResource(zb);if(ac){var bc=ub.roger[zb];yb[ac]={};for(var cc in bc)if(bc.hasOwnProperty(cc)){var dc=u.getParticipantIDFromUserID(cc);yb[ac][dc]=bc[cc];}}}ub.roger=yb;}}function ib(tb){if(tb._pendingUpdates&&tb._pendingUpdates.length){var ub=tb._pendingUpdates[0];tb._pendingUpdates=tb._pendingUpdates.slice(1);tb.handleUpdate(ub);}}function jb(tb,ub){var vb=na({},tb),wb;if(ub.threads){if(!vb.threads)vb.threads={};for(wb in ub.threads)vb.threads[wb]=Object.keys(oa((vb.threads[wb]||[]).concat(ub.threads[wb])));}if(ub.messages){if(!vb.messages)vb.messages={};for(wb in ub.messages){if(!vb.messages[wb])vb.messages[wb]={};for(var xb in ub.messages[wb])if(vb.messages[wb][xb]){vb.messages[wb][xb]=ob(vb.messages[wb][xb],ub.messages[wb][xb]);}else vb.messages[wb][xb]=ub.messages[wb][xb];}}vb.client=tb.client||ub.client;return vb;}function kb(tb,ub){var vb=na(oa(tb.folders,true),oa(ub.folders,true)),wb=tb.client||ub.client;return {folders:Object.keys(vb),client:wb};}function lb(tb,ub){for(var vb in ub)if(tb[vb]&&typeof tb[vb]==='object'){tb[vb]=ob(tb[vb],ub[vb]);}else if(ub[vb]&&typeof ub[vb]==='object'){var wb={};na(wb,ub[vb]);tb[vb]=wb;}return tb;}function mb(tb,ub){var vb=Object.assign({},tb.ids,ub.ids),wb=tb.client||ub.client;return {ids:vb,client:wb};}function nb(tb,ub){return ub;}function ob(tb,ub){var vb=tb.offset<ub.offset?tb.offset:ub.offset,wb=tb.offset+tb.limit,xb=ub.offset+ub.limit,yb=(wb>xb)?wb:xb,zb=yb-vb;return {offset:vb,limit:zb};}function pb(tb,ub){var vb=tb.client||ub.client,wb={ids:{},client:vb};na(wb.ids,tb.ids);na(wb.ids,ub.ids);return wb;}function qb(tb,ub){var vb={},wb,xb=tb.client||ub.client;delete tb.client;delete ub.client;for(wb in tb)na(vb,oa(tb[wb],wb));for(wb in ub)na(vb,oa(ub[wb],wb));var yb={client:xb};for(var zb in vb){wb=vb[zb];if(!yb[wb])yb[wb]=[];yb[wb].push(zb);}return yb;}function rb(tb,ub){var vb=tb.client||ub.client,wb=oa(tb.ids,true),xb=oa(ub.ids,true),yb=na(wb,xb);return {ids:Object.keys(yb),client:vb};}function sb(tb){this._fbid=tb;this._lastActionTimestamp=0;this._serverToClientIDs=new m();this._clientToServerIDs=new m();this._FBIDToClientIDs=new m();this._clientIDToFBIDs=new m();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};this._sendMessageQueueOptions=new la(function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this),function(ub){return this._handleSendMessageError(ub);}.bind(this),function(ub){return this._handleSendMessageTransportError(ub);}.bind(this),function(ub){return this._handleSendMessageTimeout(ub);}.bind(this),z.log,ba.sendMessageTimeout,ha.SEND_CONNECTION_RETRIES,ba.maxAutoRetries);this._registerEndpoints();}na(sb.prototype,h,{getServerThreadID:function(tb,ub){r.isThreadID(tb);wa(this,tb,ub);},getThreadFBID:function(tb,ub){r.isThreadID(tb);wa(this,tb,ub);},getClientThreadID:function(tb,ub){bb(this,tb,ub);},getClientThreadIDNow:function(tb){return ab(this,tb);},getServerThreadIDNow:function(tb){return xa(this,tb);},getClientThreadIDForPermalinks:function(tb){return za(this,tb);},convertThreadIDIfAvailable:function(tb){var ub=this._FBIDToClientIDs.getResource(tb);if(ub===(void 0)){return tb;}else return ub;},isUser:function(tb){return tb<2.2e+09||(tb>=1e+14&&tb<=100099999989999)||(tb>=8.9e+13&&tb<=89999999999999)||(tb>=6.000001e+13&&tb<=60000019999999);},canLinkExternally:function(tb){r.isThreadID(tb);var ub=u.tokenize(tb);return (ub.type=='user')||!!xa(this,tb);},fetchThreadlistInfo:function(tb,ub,vb,wb,xb){vb=vb||ja.INBOX;xb=xb||ra;var yb=wb?ka.IMMEDIATE:null,zb={client:xb};zb[vb]={offset:tb,limit:ub,filter:wb};this.__sendRequest('/ajax/mercury/threadlist_info.php',zb,yb);},fetchPinnedThreads:function(){this.__sendRequest('/mercury/pinned_threads/',{});},fetchUnseenThreadIDs:function(tb,ub){ub=ub||ra;this.fetchThreadlistInfo(fa.RECENT_THREAD_OFFSET,fa.JEWEL_THREAD_COUNT,tb,null,ub);},fetchUnreadThreadIDs:function(tb,ub){ub=ub||ra;this.__sendRequest('/ajax/mercury/unread_threads.php',{folders:[tb],client:ub});},fetchMissedMessages:function(tb,ub){ub=ub||ra;var vb={last_action_timestamp:this._lastActionTimestamp,folders:tb,client:ub};vb.last_action_timestamp=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/thread_sync.php',vb);},fetchThreadData:function(tb,ub){ub=ub||ra;r.allThreadID(tb);var vb={threads:{},client:ub},wb=[],xb=[];tb.forEach(function(zb){if(this._fetchingThreads[zb])return;this._fetchingThreads[zb]=true;var ac=xa(this,zb),bc=u.tokenize(zb);if(bc.type=='user'){wb.push(bc.value);vb.threads.user_ids=wb;}else if(bc.type=='thread'){if(ac){xb.push(ac);}else xb.push(bc.value);vb.threads.thread_fbids=xb;}else if(bc.type=='root'){if(ac){xb.push(ac);vb.threads.thread_fbids=xb;}}else if(bc.type!='pending')throw new Error('Unknown thread type',bc);}.bind(this));this.inform("fetch-thread-data",vb);for(var yb in vb.threads){this.__sendRequest('/ajax/mercury/thread_info.php',vb);break;}},ensureThreadIsFetched:function(tb,ub){ub=ub||ra;if(!this._FBIDToClientIDs.getResource(tb)&&!this._fetchingThreads[tb]){this._fetchingThreads[tb]=true;this.__sendRequest('/ajax/mercury/thread_info.php',{threads:{thread_fbids:[tb]},client:ub});}},fetchThreadMessages:function(tb,ub,vb,wb,xb){r.isThreadID(tb);xb=xb||ra;var yb,zb,ac=u.tokenize(tb),bc=xa(this,tb),cc=false;if(bc){yb=bc;zb=(ac.type=='user')?'user_ids':'thread_fbids';}else{yb=ac.value;switch(ac.type){case 'user':zb='user_ids';cc=true;break;case 'thread':zb='thread_fbids';break;}}var dc={messages:{},threads:{},client:xb};if(zb){dc.messages[zb]={};dc.messages[zb][yb]={offset:ub,limit:vb};if(cc)dc.threads[zb]=[yb];this.__sendRequest('/ajax/mercury/thread_info.php',dc,wb);}else wa(this,tb,function(ec){dc.messages.thread_fbids={};dc.messages.thread_fbids[ec]={offset:ub,limit:vb};this.__sendRequest('/ajax/mercury/thread_info.php',dc,wb);}.bind(this));},handleThreadInfoError:function(tb){var ub=tb.getRequest().getData(),vb=[];if(ub.messages){for(var wb in ub.messages.thread_fbids)vb.push(this._createServerErrorLogMessage(ab(this,wb)));for(var xb in ub.messages.user_ids)vb.push(this._createServerErrorLogMessage('user:'+xb));for(var yb in ub.messages.group_ids)vb.push(this._createServerErrorLogMessage('group:'+yb));}if(vb.length)this.handleUpdate({actions:vb,from_client:true,payload_source:y.CLIENT_CHANNEL_MESSAGE});if(ub.threads&&(ub.threads.user_ids||ub.threads.group_ids||ub.threads.thread_ids)){var zb=5,ac=true;if(!ub.retry_count){ub.retry_count=0;if(ub.messages)delete ub.messages;}else if(ub.retry_count>=zb){ac=false;(ub.threads.thread_ids||[]).forEach(function(cc){if(cc in this._fetchingThreads)delete this._fetchingThreads[cc];}.bind(this));}if(ac){var bc=ub.retry_count*1000;pa(function(){qa.log('retry_thread',ub);this.__sendRequest('/ajax/mercury/thread_info.php',ub);}.bind(this),bc);ub.retry_count++;}}},markFolderAsRead:function(tb){this.__sendRequest('/ajax/mercury/mark_folder_as_read.php',{folder:tb});var ub=[{action_type:t.MARK_ALL_READ,action_id:null,folder:tb}];this.handleUpdate({global_actions:ub,from_client:true,payload_source:y.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(tb,ub,vb){r.isThreadID(tb);wa(this,tb,function(wb){var xb={ids:{},source:vb};xb.ids[wb]=ub;this.__sendRequest('/ajax/mercury/change_read_status.php',xb);}.bind(this));},changeThreadArchivedStatus:function(tb,ub,vb){r.isThreadID(tb);wa(this,tb,function(wb){var xb={ids:{},source:vb};xb.ids[wb]=ub;this.__sendRequest('/ajax/mercury/change_archived_status.php',xb);}.bind(this));},changeThreadFolder:function(tb,ub){r.isThreadID(tb);wa(this,tb,function(vb){var wb={};wb[ub]=[vb];this.__sendRequest('/ajax/mercury/move_thread.php',wb);}.bind(this));},changeMutingOnThread:function(tb,ub){r.isThreadID(tb);wa(this,tb,function(vb){this.__sendRequest('/ajax/mercury/change_mute_thread.php',{thread_fbid:vb,mute_settings:ub,payload_source:ra});}.bind(this));},markThreadSpam:function(tb,ub){r.isThreadID(tb);wa(this,tb,function(vb){this.__sendRequest('/ajax/mercury/mark_spam.php',{id:vb,source:ub});}.bind(this));},markMessagesSpam:function(tb,ub){ga.getServerIDs(ub||[],function(vb){this.__sendRequest('/ajax/mercury/mark_spam_messages.php',{message_ids:vb});}.bind(this));},unmarkThreadSpam:function(tb,ub){r.isThreadID(tb);wa(this,tb,function(vb){this.__sendRequest('/ajax/mercury/unmark_spam.php',{id:vb,source:ub});}.bind(this));},deleteThread:function(tb,ub){r.isThreadID(tb);wa(this,tb,function(vb){var wb={ids:[vb],source:ub};this.__sendRequest('/ajax/mercury/delete_thread.php',wb);}.bind(this));},unpinThread:function(tb){r.isThreadID(tb);wa(this,tb,function(ub){this.__sendRequest('/mercury/unpin_thread/',{id:ub});}.bind(this));},deleteMessages:function(tb,ub){ga.getServerIDs(ub||[],function(vb){this.__sendRequest('/ajax/mercury/delete_messages.php',{message_ids:vb});}.bind(this));},sendDeliveryReceipts:function(tb){ga.getServerIDs(tb||[],function(ub){this.__sendRequest('/ajax/mercury/delivery_receipts.php',{message_ids:ub});}.bind(this));},sendNewMessage:function(tb,ub){ub=ub||ra;if(!tb.client_state||tb.client_state==x.SEND_TO_SERVER)ga.getServerIDs(tb.forward_message_ids||[],function(vb){var wb=u.tokenize(tb.thread_id),xb=wb.type,yb=na({},tb);yb.forward_message_ids=vb;if((xb=='root'&&wb.value==yb.message_id)||(xb=='user')){yb.client_thread_id=yb.thread_id;yb.thread_id=null;this._sendNewMessageToServer(yb,ub);}else wa(this,yb.thread_id,function(zb){wb=u.tokenize(yb.thread_id);if(wb.type=='user'){yb.other_user_fbid=wb.values;}else yb.thread_fbid=zb;yb.thread_id=null;this._sendNewMessageToServer(yb);}.bind(this));}.bind(this));},_sendNewMessageToServer:function(tb,ub){g.inform(k.ATTEMPT_RECONNECT);ub=ub||ra;this._sentMessagesTimestamp[tb.message_id]=Date.now();ca.getForFBID(this._fbid).enqueue(cb(tb),this._sendMessageQueueOptions,ub,tb);},requestMessageConfirmation:function(tb,ub){ub=ub||ra;var vb={},wb={};for(var xb in tb){var yb=xa(this,xb);if(yb){vb[yb]=tb[xb];}else{var zb=tb[xb];for(var ac=0;ac<zb.length;ac++)wb[zb[ac]]=xb;}}var bc=Object.keys(vb),cc=Object.keys(wb);if(bc.length||cc.length)this.__sendRequest('/ajax/mercury/confirm_messages.php',{thread_message_map:vb,local_messages:wb,client:ub});},handleMessageConfirmError:function(tb){var ub=tb.getRequest().getData().thread_message_map,vb=tb.getRequest().getData().local_messages;if(!ub&&!vb)return;var wb=[];for(var xb in ub){var yb=ub[xb];yb.forEach(function(bc){wb.push({action_type:p.SEND_MESSAGE,client_message_id:bc,message_id:bc,client_thread_id:null,thread_fbid:xb,status:o.UNABLE_TO_CONFIRM});});}for(var zb in vb){var ac=vb[zb];wb.push({action_type:p.SEND_MESSAGE,client_message_id:zb,message_id:zb,client_thread_id:ac,thread_fbid:null,status:o.UNABLE_TO_CONFIRM});}if(wb.length)this.handleUpdate({actions:wb,payload_source:y.CLIENT_HANDLE_ERROR});},markSeen:function(){var tb=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/mark_seen.php',{seen_timestamp:tb});},handleRoger:function(tb){var ub=tb.thread_fbid?this._FBIDToClientIDs.getResource(tb.thread_fbid):u.getThreadIDFromUserID(tb.reader);if(ub){var vb=u.getParticipantIDFromUserID(tb.reader),wb={};wb[ub]={};wb[ub][vb]=tb.time;this.inform('update-roger',wb);}},handleUpdateWaitForThread:function(tb,ub,vb){vb=vb||ra;var wb=this._FBIDToClientIDs.getResource(ub);if(wb){this.handleUpdate(tb);return;}this._FBIDToClientIDs.executeOrEnqueue(ub,function(){this._pendingUpdates.push(tb);}.bind(this));if(!this._fetchingThreads[ub]){this._fetchingThreads[ub]=true;var xb={threads:{thread_fbids:[ub]},client:vb};if(this.isUser(ub))xb={threads:{user_ids:[ub]},client:vb};this.__sendRequest('/ajax/mercury/thread_info.php',xb);}},handleUpdate:function(tb){var ub=[];if(tb&&tb.threads)for(var vb=0;vb<tb.threads.length;vb++){if(!tb.threads[vb].snippet_attachments)continue;for(var wb=0;wb<tb.threads[vb].snippet_attachments.length;wb++)if(tb.threads[vb].snippet_attachments[wb].share_xhp){ub.push({i:vb,j:wb,xhp:tb.threads[vb].snippet_attachments[wb].share_xhp});tb.threads[vb].snippet_attachments[wb].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}var xb={actions:[],threads:[]};if(tb){if(tb.actions)xb.actions=tb.actions.map(function(ac){return v.obfuscateMessage(ac);});if(tb.threads)xb.threads=tb.threads.map(function(ac){return v.obfuscateThread(ac);});}var yb=na({},tb,xb);qa.debug('update:'+tb.payload_source,{payload:yb,from_client:tb.from_client});for(var zb=0;zb<ub.length;zb++)tb.threads[ub[zb].i].snippet_attachments[ub[zb].j].share_xhp=ub[zb].xhp;for(zb in tb){ma.getForFBID(this._fbid).synchronizeInforms(function(){if(!tb.from_client){hb(this,tb);this.inform('payload-preprocessed',tb);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',tb);this.inform('update-threads',tb);this.inform('update-unread',tb);this.inform('update-threadlist',tb);this.inform('update-pinned-threads',tb);this.inform('update-messages',tb);this.inform('update-unseen',tb);this.inform('update-typing-state',tb);this.inform('update-roger',tb.roger);this.inform('model-update-completed',null);ib(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(tb,ub,vb,wb){qa.debug('handle_send_message_error_common',{reliability_error_status:vb,request_error_status:ub});var xb=tb.getData(),yb=xb.message_batch,zb=yb.map(function(bc){var cc={action_type:p.SEND_MESSAGE,thread_fbid:bc.thread_fbid,client_message_id:bc.message_id,message_id:bc.message_id,client_thread_id:bc.client_thread_id,status:ub,error_data:wb};return cc;});zb.forEach(function(bc){db(this,bc,vb);},this);var ac={actions:zb,payload_source:y.CLIENT_HANDLE_ERROR};this.handleUpdate(ac);},handleSendMessageError:function(tb){var ub=tb.getPayload(),vb=null,wb=null;if(ub&&ub.error_payload){vb=o.UNCONFIRMED;wb='send_error';}else{vb=o.ERROR;wb='request_error'+eb(tb);}var xb=tb.error;if(xb===1404102)i.verboseErrorHandler(tb);var yb=/<.*>/.test(tb.getErrorDescription())?tb.getErrorSummary():tb.getErrorDescription();this._handleSendMessageErrorCommon(tb.getRequest(),vb,wb,{type:s.SERVER,code:tb.getError(),description:yb,is_transient:tb.isTransient()});},handleSendMessageTransportError:function(tb){this._handleSendMessageErrorCommon(tb.getRequest(),o.ERROR,'transport_error'+eb(tb),{type:s.TRANSPORT,code:tb.getError(),is_transient:true});},handleSendMessageTimeout:function(tb){this._handleSendMessageErrorCommon(tb,o.ERROR,'transport_timeout',{type:s.TIMEOUT,is_transient:true});},getLastActionTimestamp:function(){return this._lastActionTimestamp;},_createServerErrorLogMessage:function(tb){return {action_type:p.LOG_MESSAGE,thread_id:tb,message_id:tb,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ea.UNKNOWN,log_message_type:w.SERVER_ERROR,log_message_data:{}};},_getForAsyncRequest:function(tb){var ub=tb.getData(),vb=ub.request_user_id?ub.request_user_id:l.getID();return sb.getForFBID(vb);},__handleUpdate:function(tb,ub){this._getForAsyncRequest(ub).handleUpdate(tb);},_handleThreadInfoError:function(tb){var ub=this._getForAsyncRequest(tb.getRequest());ub.handleThreadInfoError(tb);},_handleSendMessageError:function(tb){var ub=this._getForAsyncRequest(tb.getRequest());ub.handleSendMessageError(tb);},_handleSendMessageTransportError:function(tb){var ub=this._getForAsyncRequest(tb.getRequest());ub.handleSendMessageTransportError(tb);},_handleSendMessageTimeout:function(tb){var ub=this._getForAsyncRequest(tb);ub.handleSendMessageTimeout(tb);},_handleMessageConfirmError:function(tb){var ub=this._getForAsyncRequest(tb.getRequest());ub.handleMessageConfirmError(tb);},_registerEndpoints:function(){var tb={'/ajax/mercury/thread_sync.php':{request_user_id:this._fbid,mode:ka.IDEMPOTENT,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/thread_info.php':{request_user_id:this._fbid,mode:ka.BATCH_DEFERRED_MULTI,batch_function:jb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this),error_handler:function(ub){return this._handleThreadInfoError(ub);}.bind(this)},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/change_read_status.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:mb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/mark_seen.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:nb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/confirm_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this),error_handler:function(ub){return this._handleMessageConfirmError(ub);}.bind(this)},'/ajax/mercury/threadlist_info.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:lb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/mark_spam.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/mark_spam_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/unmark_spam.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/unread_threads.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:kb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/chat/settings.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:pb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/delete_thread.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:rb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/delete_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/delivery_receipts.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/move_thread.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:qb,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/ajax/mercury/change_mute_thread.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/mercury/pinned_threads/':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)},'/mercury/unpin_thread/':{request_user_id:this._fbid,mode:ka.IMMEDIATE,handler:function(ub,vb){return this.__handleUpdate(ub,vb);}.bind(this)}};ka.registerEndpoints(tb);},__sendRequest:function(tb,ub,vb){ka.trySend(tb,ub,vb,this._fbid);}});Object.assign(sb,da);e.exports=sb;},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","MercuryAudioType","MercuryConfig","StoryAttachmentStyle"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();'use strict';var l={getAttachIconClass:function(m){switch(m){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(m){if(m.startsWith('image')){return 'MercuryPhotoIcon';}else if(m.startsWith('video')){return 'MercuryVideoIcon';}else if(m.startsWith('audio')){return 'MercuryMusicIcon';}else if(m.startsWith('text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(m){if(m.startsWith('image')){return g.PHOTO;}else if(m.startsWith('video')){return g.VIDEO;}else if(m.startsWith('audio')){return g.MUSIC;}else if(m.startsWith('text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(m){var n=[];for(var o=0;o<m.length;o++){var p=m[o];if(p.attach_type===h.PHOTO){n.push(p);}else if(p.filename){var q=l.getAttachTypeByMime(p.filetype),r={};r.attach_type=h.FILE;r.name=p.filename;r.icon_type=q;r.url='';n.push(r);}}return n;},get:function(m){var n=[];if(m.attachments){n=m.attachments;}else if(m.raw_attachments)n=this.convertRaw(m.raw_attachments);if(!(m.attachments&&m.attachments.length>0)){if(m.sticker_id)return n.concat([{attach_type:h.STICKER}]);if(m.preview_attachments&&m.preview_attachments.length>0)return n.concat(m.preview_attachments);}return n;},hasBubbleTail:function(m,n){var o=this.get(m);if(j.WWWMessengerCommerceGK)return !o.some(function(p){var q=p.share&&p.share.style_list,r=q&&q.some(function(s){return s===k.RETAIL_RECEIPT;});return p.attach_type===h.SHARE&&r&&n;});if(j.MercuryStoryAttachmentsGK&&!m.body)return !o.some(function(p){return p.attach_type===h.SHARE&&p.share&&p.share.media.image&&n;});return true;},isVoiceMessage:function(m){return (m===i.AudioClip||m===i.VoiceMessageWithTranscript);}};e.exports=l;},null);
__d("MercuryThreads",["EventEmitter","ImmutableObject","KeyedCallbackManager","LogHistory","Map","MercuryActionType","MercuryAssert","MercuryAttachment","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryLoggingHelper","MercuryPayloadSource","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryServerRequests","Set","MercuryThreadInformer","setImmediate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){b.__markCompiled&&b.__markCompiled();'use strict';var aa=new g(),ba=j.getInstance('mercury_threads');function ca(da){this.$MercuryThreads0=da;this.$MercuryThreads1=w.getForFBID(this.$MercuryThreads0);this.$MercuryThreads2=y.getForFBID(this.$MercuryThreads0);this.$MercuryThreads3=p.getParticipantIDFromUserID(this.$MercuryThreads0);this.$MercuryThreads4=false;this.$MercuryThreads5=new i();this.$MercuryThreads6=new x();this.$MercuryThreads7=false;this.$MercuryThreads8=new x();this.$MercuryThreads9=new x();this.$MercuryThreadsa();}ca.prototype.getThreadMetaNow=function(da){m.isThreadID(da);return this.$MercuryThreads5.getResource(da);};ca.prototype.getOrFetch=function(da){var ea=this.getThreadMetaNow(da);if(!ea&&!this.$MercuryThreads9.has(da))this.$MercuryThreads8.add(da);if(this.$MercuryThreads8.size>0&&!this.$MercuryThreads7)this.$MercuryThreadsb();return ea;};ca.prototype.$MercuryThreadsb=function(){if(this.$MercuryThreads7)return;this.$MercuryThreads7=true;z(function(){this.$MercuryThreads7=false;this.$MercuryThreads8.forEach(function(da){return this.$MercuryThreads9.add(da);}.bind(this));this.getMultiThreadMeta(Array.from(this.$MercuryThreads8),function(da){for(var ea in da)da.hasOwnProperty(ea)&&this.$MercuryThreads9["delete"](ea);}.bind(this));this.$MercuryThreads8.clear();}.bind(this));};ca.prototype.getThreadMeta=function(da,ea,fa){return this.getMultiThreadMeta([da],function(ga){return ea(ga[da]);},fa);};ca.prototype.getMultiThreadMeta=function(da,ea,fa){m.allThreadID(da);var ga=this.$MercuryThreads5.executeOrEnqueue(da,ea),ha=this.$MercuryThreads5.getUnavailableResources(ga);if(ha.length){var ia=[];for(var ja=0;ja<ha.length;ja++){var ka=ha[ja],la=p.tokenize(ka),ma=la.type,na=la.value;if(ma=='user'){var oa=p.getParticipantIDFromUserID(na);this.createNewLocalThread(ka,oa===this.$MercuryThreads3?[this.$MercuryThreads3]:[this.$MercuryThreads3,oa]);}else ia.push(ka);}if(ia.length)this.$MercuryThreads1.fetchThreadData(ia,fa);}return ga;};ca.addListener=function(da,ea){return aa.addListener(da,ea);};ca.prototype.unsubscribe=function(da){this.$MercuryThreads5.unsubscribe(da);};ca.prototype.getCanonicalThreadToParticipant=function(da,ea,fa,ga){var ha=p.getThreadIDFromParticipantID(da),ia=this.$MercuryThreads5.getResource(ha);if(typeof ia=='undefined'){ia=this.createNewLocalThread(ha,this.$MercuryThreads3===da?[this.$MercuryThreads3]:[this.$MercuryThreads3,da],ea);!ga&&this.$MercuryThreads1.fetchThreadData([ha],fa);}return ia;};ca.prototype.createNewLocalThread=function(da,ea,fa){var ga=this.$MercuryThreads5.getResource(da);if(!ga){var ha=p.tokenize(da),ia=ha.type,ja=ha.value;ga=new h({thread_id:da,last_action_id:null,participants:Array.from(ea),name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:fa?fa:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ia==='user'?ja:null,is_canonical_user:ia=='user',is_canonical:this.$MercuryThreadsc(ea),is_subscribed:true,root_message_threading_id:null,folder:v.INBOX,is_archived:false,mode:u.TITAN_ORIGINATED});this.$MercuryThreads5.setResource(da,ga);}return ga;};ca.prototype.isEmptyLocalThread=function(da){var ea=this.$MercuryThreads5.getResource(da);if(!ea)return false;var fa=p.tokenize(da),ga=fa.type;return ga=='root'&&!ea.timestamp;};ca.prototype.isNewEmptyLocalThread=function(da){if(!this.isEmptyLocalThread(da))return false;var ea=this.$MercuryThreads5.getResource(da);return !!ea.participants&&ea.participants.length===0;};ca.prototype.$MercuryThreadsd=function(da,ea){if(!da||!da.length)return;var fa=new k(),ga=new k(),ha=new k(),ia=[];for(var ja=0;ja<da.length;ja++){var ka=da[ja];if(ka.is_forward)continue;var la=ka.action_type;if(la==l.LOG_MESSAGE&&ka.log_message_type==q.SERVER_ERROR)continue;var ma=!!(ka.sync_id||ka.action_id),na=ka.thread_id;m.isThreadID(na);var oa=this.$MercuryThreads5.getResource(na);if(!oa&&!ma&&la==l.USER_GENERATED_MESSAGE){oa=this.$MercuryThreadse(ka);this.$MercuryThreads5.setResource(na,oa);}if(!oa)continue;if(la==l.LOG_MESSAGE||la==l.USER_GENERATED_MESSAGE)ma=!ea;if(oa.server_timestamp&&ka.timestamp<=oa.server_timestamp&&ma)continue;if(!ha.has(na))ha.set(na,Object.assign({},oa));this.$MercuryThreadsf(ha.get(na),ka,ea);if(la==l.USER_GENERATED_MESSAGE)fa.set(na,ka);if(la==l.USER_GENERATED_MESSAGE||la==l.LOG_MESSAGE||la==l.SEND_MESSAGE)if(ka&&ka.timestamp&&(!ga.has(na)||ka.timestamp>ga.get(na).timestamp))ga.set(na,ka);}ha.forEach(function(pa,qa){var ra=fa.get(qa);if(ra)this.$MercuryThreadsg(pa,ra);var sa=ga.get(qa),ta=pa.timestamp;if(sa){if(sa.timestamp>ta)Object.assign(pa,{timestamp_absolute:sa.timestamp_absolute,timestamp_relative:sa.timestamp_relative,timestamp:sa.timestamp});var ua=pa.server_timestamp;if(!ea&&sa.timestamp>ua)pa.server_timestamp=sa.timestamp;}var va=new h(pa);this.$MercuryThreads5.setResource(qa,va);ia.push(r.obfuscateThread(va));}.bind(this),this);ia.length&&ba.debug('threads_updated',{threads:ia});};ca.prototype.$MercuryThreadsf=function(da,ea,fa){var ga=ea.action_type;if(ga==l.USER_GENERATED_MESSAGE||ga==l.LOG_MESSAGE){ea.is_unread&&da.unread_count++;da.message_count++;da.is_archived=false;}switch(ga){case l.DELETE_THREAD:da.message_count=0;this.$MercuryThreadsh(ea.thread_id);break;case l.USER_GENERATED_MESSAGE:if(da.last_read_timestamp>=ea.timestamp)this.$MercuryThreadsi(da,ea,true);this.$MercuryThreadsj(da,ea.author);break;case l.SEND_MESSAGE:var ha=ea.log_message_type;if(ha==q.THREAD_IMAGE){da.image_src=ea.log_message_data.image?ea.log_message_data.image.preview_url:null;this.$MercuryThreadsk(ea.thread_id);}da.snippet_attachments=ea.attachments;break;case l.LOG_MESSAGE:var ha=ea.log_message_type;if(ha==q.SUBSCRIBE){this.$MercuryThreadsl(da,ea.log_message_data.added_participants);this.$MercuryThreadsk(ea.thread_id);}else if(ha==q.UNSUBSCRIBE){this.$MercuryThreadsm(da,ea.log_message_data.removed_participants);this.$MercuryThreadsk();}else if(ha==q.THREAD_IMAGE){if(!fa)da.image_src=ea.log_message_data.image?ea.log_message_data.image.preview_url:null;}else if(ha==q.THREAD_NAME){if(da.name!==ea.log_message_data.name)this.$MercuryThreadsk(ea.thread_id);da.name=ea.log_message_data.name;}break;case l.CHANGE_READ_STATUS:var ia=this.$MercuryThreadsi(da,ea,ea.mark_as_read);if(ia&&ea.timestamp)da.last_read_timestamp=ea.timestamp;if(ia&&fa)this.$MercuryThreads1.changeThreadReadStatus(da.thread_id,ea.mark_as_read,ea.source);break;case l.CHANGE_ARCHIVED_STATUS:if(da.is_archived!=ea.archived){da.is_archived=ea.archived;this.$MercuryThreadsk(ea.thread_id);}break;case l.CHANGE_FOLDER:if(da.folder!=ea.new_folder){da.folder=ea.new_folder;this.$MercuryThreadsk(ea.thread_id);}break;case l.DELETE_MESSAGES:if(fa){da.snippet='...';da.snippet_has_attachment=false;da.snippet_attachments=null;da.snippet_sender=null;da.is_forwarded_snippet=false;this.$MercuryThreadsk(ea.thread_id);}else if(ea.message_ids)da.message_count=da.message_count-ea.message_ids.length;break;case l.CHANGE_MUTE_SETTINGS:if(ea.mute_settings!==(void 0)){var ja=this.$MercuryThreads0+'@facebook.com';if(da.mute_settings){if(ea.mute_settings){var ka={};ka[ja]=ea.mute_settings;da.mute_settings=Object.assign({},da.mute_settings,ka);}else{da.mute_settings=Object.assign({},da.mute_settings);delete da.mute_settings[ja];}this.$MercuryThreadsk(da.thread_id);}}break;case l.ADD_PARTICIPANTS:this.$MercuryThreadsl(da,ea.participants);this.$MercuryThreadsk(da.thread_id);break;}};ca.prototype.$MercuryThreadse=function(da){var ea=p.tokenize(da.thread_id),fa=ea.type,ga=ea.value,ha=this.$MercuryThreadsc(da.specific_to_list);return new h({thread_id:da.thread_id,last_action_id:null,participants:da.specific_to_list,name:null,snippet:da.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:da.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:da.timestamp_absolute,timestamp_relative:da.timestamp_relative,timestamp:da.timestamp,canonical_fbid:fa==='user'?ga:null,is_canonical_user:fa==='user',is_canonical:ha,is_subscribed:true,root_message_threading_id:da.message_id,folder:v.INBOX,is_archived:false,mode:u.TITAN_ORIGINATED});};ca.prototype.$MercuryThreadsi=function(da,ea,fa){if(ea.timestamp)this.$MercuryThreadsn(da.thread_id,fa,ea.timestamp);if(!da||!da.thread_id)return false;if(!da.timestamp){this.$MercuryThreads6.add(da.thread_id);return false;}var ga=!da.unread_count;if(fa==ga)return false;da.unread_count=fa?0:1;this.$MercuryThreadsk(da.thread_id);return true;};ca.prototype.$MercuryThreadso=function(da){var ea=this.$MercuryThreads5.getAllResources();for(var fa in ea)if(ea.hasOwnProperty(fa)){var ga=ea[fa];if(ga.folder==da){this.$MercuryThreads5.setResource(fa,h.setProperty(ga,'unread_count',0));this.$MercuryThreadsk(fa);}}};ca.prototype.$MercuryThreadsl=function(da,ea){var fa=new x(da.participants);da.participants=Array.from(da.participants);ea.forEach(function(ga){if(!fa.has(ga)){da.participants.push(ga);if(ga===this.$MercuryThreads3)da.is_subscribed=true;}}.bind(this));};ca.prototype.$MercuryThreadsm=function(da,ea){var fa=new x(ea);da.participants=da.participants.filter(function(ga){return !fa.has(ga);});if(fa.has(this.$MercuryThreads3))da.is_subscribed=false;};ca.prototype.$MercuryThreadsj=function(da,ea){if(da.participants[0]!=ea){da.participants=da.participants.filter(function(fa){return fa!=ea;});da.participants.unshift(ea);}};ca.prototype.$MercuryThreadsg=function(da,ea){var fa=ea.body,ga=ea.subject,ha='';if(ga){ga=ga.toLowerCase();if(fa.slice(0,ga.length).toLowerCase()==ga){ha=fa;}else if(fa){ha=ga+' \u00B7 '+fa;}else ha=ga;}else ha=fa;da.snippet=ha;da.snippet_has_attachment=ea.has_attachment;if(ea.raw_attachments&&ea.raw_attachments.length>0){var ia=n.convertRaw(ea.raw_attachments);da.snippet_attachments=ia;}else da.snippet_attachments=ea.attachments;da.is_forwarded_snippet=!!ea.forward_count;da.snippet_sender=ea.author;};ca.prototype.$MercuryThreadsc=function(da){return da.filter(function(ea){return ea!=this.$MercuryThreads3;}.bind(this)).length<=1;};ca.prototype.$MercuryThreadsa=function(){this.$MercuryThreads1.subscribe('update-threads',function(da,ea){var fa=(ea.actions||[]).filter(function(ga){return ga.thread_id;});if(ea.threads&&ea.payload_source==s.SERVER_FETCH_THREAD_INFO)ea.threads.forEach(function(ga){var ha=ga.thread_id;if(this.$MercuryThreads6.has(ha)){this.$MercuryThreads6["delete"](ha);if(ga.unread_count)this.$MercuryThreads1.changeThreadReadStatus(ga.thread_id,true);}}.bind(this));this.$MercuryThreadsp(ea.threads);this.$MercuryThreadsd(fa,ea.from_client);ea.threads&&ea.threads.forEach(function(ga){this.$MercuryThreadsk(ga.thread_id);}.bind(this));if(ea.global_actions)ea.global_actions.forEach(function(ga){if(ga.action_type==o.MARK_ALL_READ)this.$MercuryThreadso(ga.folder);}.bind(this));if(this.$MercuryThreads4){this.$MercuryThreads4=false;aa.emit('change');}}.bind(this));};ca.prototype.$MercuryThreadsp=function(da){if(!da||!da.length)return;var ea={},fa=[];da.forEach(function(ga){var ha=new h(ga);ea[ga.thread_id]=ha;fa.push(r.obfuscateThread(ha));});fa.length&&ba.debug('threads_added',{threads:fa});this.$MercuryThreads5.addResourcesAndExecute(ea);};ca.prototype.$MercuryThreadsk=function(da){this.$MercuryThreads4=true;this.$MercuryThreads2.updatedThread(da);};ca.prototype.$MercuryThreadsh=function(da){this.$MercuryThreads4=true;this.$MercuryThreads2.deletedThread(da);};ca.prototype.$MercuryThreadsn=function(da,ea,fa){this.$MercuryThreads4=true;this.$MercuryThreads2.changedThreadReadState(da,ea,fa);};Object.assign(ca,t);e.exports=ca;},null);
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;},null);
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionType","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){b.__markCompiled&&b.__markCompiled();var u=(g.getSupportedFolders()||[]).filter(function(ma){return ma!=n.ACTION_ARCHIVED;}),v='unread_thread_hash',w='unseen_thread_list',x=m.MAX_UNREAD_COUNT,y=h.getInstance('mercury_unread_state');function z(ma){this._fbid=ma;this._serverRequests=o.getForFBID(this._fbid);this._threadInformer=p.getForFBID(this._fbid);this._threads=q.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};u.forEach(function(na){this._initialUnreadCount[na]=0;this._maxCount[na]=false;this._unreadResources[na]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(na,oa){ea(this,oa);var pa=oa.global_actions||[];for(var qa=0;qa<pa.length;qa++){var ra=pa[qa];if(ra.action_type==k.MARK_ALL_READ)ha(this,ra.folder,ra.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(na,oa){ja(this,oa);}.bind(this));}s(z.prototype,{getUnreadCount:function(ma){if(this.exceedsMaxCount(ma)){y.error('unguarded_unread_count_fetch',{});return 0;}return da(this,ma);},exceedsMaxCount:function(ma){return this._maxCount[ma]||(da(this,ma)>x);},markFolderAsRead:function(ma){if(this._maxCount[ma]||da(this,ma)>0)this._serverRequests.markFolderAsRead(ma);}});s(z,l);function aa(ma,na,oa){ma._unreadResources[na].setResource(v,oa);ma._unreadResources[na].setResource(w,Object.keys(oa));}function ba(ma,na,oa){var pa=ma._unreadResources[na].executeOrEnqueue(v,oa),qa=ma._unreadResources[na].getUnavailableResources(pa);if(qa.length)ma._serverRequests.fetchUnreadThreadIDs(na);}function ca(ma,na){return ma._unreadResources[na].getResource(v);}function da(ma,na){var oa=ma._unreadResources[na].getResource(w);if(oa){return oa.length;}else return ma._initialUnreadCount[na];}function ea(ma,na){var oa;(na.unread_thread_fbids||[]).forEach(function(pa){oa=pa.folder;if(!la(oa))return;var qa=pa.thread_fbids||[];qa=qa.concat(pa.other_user_fbids||[]);var ra=ia(ma,qa);aa(ma,oa,t(ra,true));if(ra.length>x)ma._maxCount[oa]=true;ma._threadInformer.updatedUnreadState();});(na.message_counts||[]).forEach(function(pa){if(pa.unread_count===(void 0))return;oa=pa.folder;if(pa.unread_count>x){ma._maxCount[oa]=true;aa(ma,oa,{});ma._threadInformer.updatedUnreadState();}else{ma._initialUnreadCount[oa]=pa.unread_count;if(ma._initialUnreadCount[oa]===0)aa(ma,oa,{});ma._threadInformer.updatedUnreadState();}});(na.actions||[]).forEach(function(pa){if(pa.is_forward)return;var qa=j,ra=pa.other_user_fbid?pa.other_user_fbid:pa.thread_fbid,sa=pa.thread_id?pa.thread_id:ra;if(pa.action_type==qa.DELETE_THREAD){u.forEach(function(ua){ga(ma,ua,sa);});}else if(pa.action_type==qa.CHANGE_ARCHIVED_STATUS||pa.action_type==qa.CHANGE_FOLDER){var ta=ma._threads.getThreadMetaNow(pa.thread_id);oa=g.getFromMeta(ta);if(la(oa)&&ta.unread_count>0)fa(ma,oa,sa);u.forEach(function(ua){if(ua!=oa)ga(ma,ua,sa);});}else{oa=ka(ma,pa);if(!la(oa))return;if(pa.action_type==qa.CHANGE_READ_STATUS){if(pa.mark_as_read){ga(ma,oa,sa,pa.timestamp);}else fa(ma,oa,sa,pa.timestamp);}else if(pa.action_type==qa.USER_GENERATED_MESSAGE||pa.action_type==qa.LOG_MESSAGE)if(pa.is_unread)fa(ma,oa,sa,pa.timestamp);}});}function fa(ma,na,oa,pa){if(ma._maxCount[na])return;ba(ma,na,function(qa){var ra=ma._allReadTimestamp[na]||0,sa=ma._threadReadTimestamp[oa]||0,ta=pa||Number.POSITIVE_INFINITY;if(ta>=ra&&ta>=sa&&!qa[oa]){qa[oa]=pa||0;aa(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ga(ma,na,oa,pa){if(ma._maxCount[na])return;ba(ma,na,function(qa){if(pa){var ra=ma._threadReadTimestamp[oa];if(!ra||ra<pa)ma._threadReadTimestamp[oa]=pa;}var sa=qa[oa];if(pa&&typeof sa=='number'&&pa<sa)return;if(oa in qa){delete qa[oa];aa(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ha(ma,na,oa){ma._maxCount[na]=false;aa(ma,na,{});ma._allReadTimestamp[na]=Math.max(ma._allReadTimestamp[na]||0,oa||0);ma._threadInformer.updatedUnreadState();}function ia(ma,na){return na.map(ma._serverRequests.convertThreadIDIfAvailable,ma._serverRequests);}function ja(ma,na){u.forEach(function(oa){var pa=ca(ma,oa);if(!pa)return;for(var qa in na){var ra=na[qa];if(pa[qa]){pa[ra]=pa[qa];delete pa[qa];}}aa(ma,oa,pa);});}function ka(ma,na){var oa=na.thread_id?ma._threads.getThreadMetaNow(na.thread_id):null;return oa?g.getFromMeta(oa):na.folder;}function la(ma){return r(u,ma);}e.exports=z;},null);